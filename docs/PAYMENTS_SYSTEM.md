# نظام إدارة المدفوعات - Bakery Management System

## نظرة عامة

نظام إدارة المدفوعات هو جزء شامل من نظام إدارة المخابز يتيح تتبع ومراقبة جميع المدفوعات الواردة من المتاجر. يوفر النظام واجهة سهلة الاستخدام لإدارة المدفوعات مع إمكانيات متقدمة للفلترة والتصدير والإحصائيات.

## الميزات الرئيسية

### 1. إدارة المدفوعات

- **إضافة دفعة جديدة**: تسجيل دفعات جديدة مع ربطها بالمتاجر والطلبات
- **تعديل المدفوعات**: تحديث تفاصيل المدفوعات الموجودة
- **حذف المدفوعات**: إزالة المدفوعات مع تأكيد الأمان
- **تغيير حالة الدفع**: تحديث حالة المدفوعات (معلق، جزئي، مدفوع، متأخر)

### 2. عرض المدفوعات

- **عرض بطاقات**: عرض المدفوعات في شكل بطاقات منظمة
- **معلومات شاملة**: عرض جميع تفاصيل الدفعة (المبلغ، التاريخ، الطريقة، الحالة)
- **أيقونات تفاعلية**: أزرار سريعة للعرض والتعديل والحذف

### 3. الفلترة والبحث

- **البحث النصي**: البحث في رقم الدفعة أو اسم المتجر
- **فلترة بالمتجر**: تصفية المدفوعات حسب المتجر المحدد
- **فلترة بالحالة**: تصفية حسب حالة الدفع
- **فلترة بطريقة الدفع**: تصفية حسب طريقة الدفع (نقدي، بنكي، مختلط)
- **فلترة بالتاريخ**: تحديد نطاق زمني للمدفوعات
- **فلترة بالمبلغ**: تحديد نطاق مبالغ المدفوعات
- **فلاتر سريعة**: أزرار سريعة للحالات والطرق الشائعة

### 4. الإحصائيات والتقارير

- **إحصائيات شاملة**: عرض إجمالي المدفوعات وتوزيعها
- **مؤشرات الأداء**: معدلات الإنجاز والمدفوعات المتأخرة
- **توزيع طرق الدفع**: إحصائيات طرق الدفع المختلفة
- **أفضل المتاجر**: ترتيب المتاجر حسب المدفوعات
- **اتجاهات زمنية**: مقارنة الأداء مع الفترات السابقة

### 5. التصدير

- **تصدير Excel**: تصدير المدفوعات بصيغة XLSX
- **تصدير CSV**: تصدير البيانات بصيغة CSV
- **فلترة التصدير**: تصدير البيانات المفلترة فقط

### 6. التصفح والتنقل

- **تصفح بالصفحات**: تقسيم النتائج على صفحات متعددة
- **تحكم في عدد العناصر**: اختيار عدد المدفوعات المعروضة
- **تنقل سهل**: أزرار التنقل بين الصفحات

## الواجهة والمكونات

### صفحة المدفوعات الرئيسية (`PaymentsPage.jsx`)

- **العرض المزدوج**: التبديل بين قائمة المدفوعات والإحصائيات
- **شريط الأدوات**: أزرار الإضافة والتصدير والتبديل بين العروض
- **إدارة الحالة**: تتبع حالة التحميل والأخطاء والبيانات

### مكون بطاقة المدفوعات (`PaymentCard.jsx`)

- **عرض منظم**: عرض تفاصيل الدفعة بشكل جذاب
- **أيقونات الحالة**: رموز ملونة لحالات الدفع المختلفة
- **إجراءات سريعة**: أزرار للعرض والتعديل والحذف
- **تحديث الحالة**: قائمة منسدلة لتغيير حالة الدفع

### نافذة المدفوعات (`PaymentModal.jsx`)

- **نموذج شامل**: جميع حقول المدفوعات المطلوبة
- **التحقق من البيانات**: فحص شامل لصحة البيانات
- **ربط المتاجر**: قائمة ديناميكية للمتاجر المتاحة
- **ربط الطلبات**: قائمة الطلبات حسب المتجر المختار

### مكون الفلاتر (`PaymentFilters.jsx`)

- **فلاتر متقدمة**: خيارات فلترة شاملة
- **فلاتر سريعة**: أزرار للحالات الشائعة
- **تنظيف الفلاتر**: مسح جميع الفلاتر بنقرة واحدة
- **حفظ الحالة**: الاحتفاظ بالفلاتر أثناء التنقل

### مكون الإحصائيات (`PaymentStatistics.jsx`)

- **بطاقات إحصائية**: عرض المؤشرات الرئيسية
- **مخططات بيانية**: تمثيل بصري للبيانات
- **فترات زمنية**: اختيار الفترة الزمنية للإحصائيات
- **مقارنات**: مقارنة الأداء مع الفترات السابقة

### مكون التصفح (`PaymentPagination.jsx`)

- **تنقل كامل**: أزرار للصفحة الأولى والأخيرة
- **معلومات الصفحة**: عرض رقم الصفحة الحالية والإجمالي
- **تحكم في العدد**: اختيار عدد العناصر لكل صفحة
- **تصميم متجاوب**: يتكيف مع الشاشات المختلفة

## قاعدة البيانات

### جدول المدفوعات (`payments`)

```sql
CREATE TABLE payments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    store_id INT NOT NULL,
    order_id INT NULL,
    amount DECIMAL(10,2) NOT NULL,
    payment_method ENUM('cash', 'bank', 'mixed') NOT NULL DEFAULT 'cash',
    payment_type ENUM('full', 'partial', 'refund') NOT NULL DEFAULT 'full',
    payment_date DATE NOT NULL,
    status ENUM('pending', 'partial', 'paid', 'overdue') NOT NULL DEFAULT 'pending',
    reference_number VARCHAR(100) NULL,
    notes TEXT NULL,
    created_by INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (store_id) REFERENCES stores(id),
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

## API Endpoints

### المدفوعات الأساسية

- `GET /api/payments` - جلب جميع المدفوعات مع الفلترة
- `POST /api/payments` - إضافة دفعة جديدة
- `GET /api/payments/:id` - جلب دفعة محددة
- `PUT /api/payments/:id` - تحديث دفعة
- `DELETE /api/payments/:id` - حذف دفعة
- `PATCH /api/payments/:id/status` - تحديث حالة الدفع

### الإحصائيات والتقارير

- `GET /api/payments/statistics` - جلب إحصائيات المدفوعات
- `GET /api/payments/report` - جلب تقرير مفصل
- `GET /api/payments/export` - تصدير المدفوعات

## التكوين والإعدادات

### متطلبات النظام

- **Frontend**: React 18+, Tailwind CSS
- **Backend**: Node.js, Express.js
- **Database**: MySQL 8.0+
- **Authentication**: JWT tokens

### ملفات التكوين

- **Frontend**: `frontend/src/services/paymentsAPI.js`
- **Backend**: `backend/routes/payments.js`
- **Database**: `database/payments_table.sql`

## الاستخدام

### إضافة دفعة جديدة

1. انقر على زر "إضافة دفعة" في الصفحة الرئيسية
2. اختر المتجر من القائمة المنسدلة
3. اختر الطلب (اختياري) إذا كانت الدفعة مرتبطة بطلب محدد
4. أدخل مبلغ الدفعة
5. اختر طريقة الدفع (نقدي، بنكي، مختلط)
6. حدد نوع الدفعة (كاملة، جزئية، استرداد)
7. اختر تاريخ الدفع
8. أدخل رقم المرجع (مطلوب للدفع البنكي)
9. أضف ملاحظات إضافية إذا لزم الأمر
10. انقر على "إضافة" لحفظ الدفعة

### تعديل دفعة موجودة

1. انقر على أيقونة التعديل في بطاقة الدفعة
2. قم بتحديث البيانات المطلوبة
3. انقر على "تحديث" لحفظ التغييرات

### فلترة المدفوعات

1. استخدم مربع البحث للبحث النصي
2. اختر المتجر من القائمة المنسدلة
3. حدد حالة الدفع المطلوبة
4. اختر طريقة الدفع
5. حدد نطاق التاريخ والمبلغ
6. استخدم الفلاتر السريعة للخيارات الشائعة

### عرض الإحصائيات

1. انقر على زر "الإحصائيات" في الصفحة الرئيسية
2. اختر الفترة الزمنية من القائمة المنسدلة
3. اطلع على المؤشرات والمخططات المختلفة

### تصدير البيانات

1. طبق الفلاتر المطلوبة (اختياري)
2. انقر على زر "تصدير"
3. اختر صيغة التصدير (Excel أو CSV)
4. سيتم تحميل الملف تلقائياً

## الأمان والصلاحيات

### التحقق من الهوية

- جميع العمليات تتطلب تسجيل دخول صحيح
- استخدام JWT tokens للمصادقة

### الصلاحيات

- **المدير**: جميع العمليات
- **المستخدم العادي**: عرض وإضافة المدفوعات فقط
- **المحاسب**: جميع العمليات ما عدا الحذف

### حماية البيانات

- تشفير كلمات المرور
- فحص صحة البيانات في الخادم والعميل
- حماية من هجمات SQL Injection

## استكشاف الأخطاء

### مشاكل شائعة

1. **عدم ظهور المدفوعات**: تحقق من اتصال قاعدة البيانات
2. **فشل في الحفظ**: تحقق من صحة البيانات المدخلة
3. **مشاكل التصدير**: تحقق من صلاحيات الملفات
4. **بطء التحميل**: تحقق من فهرسة قاعدة البيانات

### سجلات الأخطاء

- **Frontend**: وحدة تحكم المتصفح
- **Backend**: ملفات السجل في مجلد logs
- **Database**: سجلات MySQL

## التطوير والصيانة

### إضافة ميزات جديدة

1. تحديث نموذج قاعدة البيانات
2. إضافة API endpoints جديدة
3. تحديث واجهة المستخدم
4. إضافة اختبارات

### النسخ الاحتياطي

- نسخ احتياطي يومي لقاعدة البيانات
- نسخ احتياطي أسبوعي للملفات
- اختبار استعادة البيانات شهرياً

## الدعم والمساعدة

للحصول على الدعم أو الإبلاغ عن مشاكل:

- البريد الإلكتروني: support@bakery-system.com
- الهاتف: +963-XXX-XXXX
- الوثائق: docs.bakery-system.com
